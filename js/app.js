/*!
 * app.js
 * @author mo-om
 * @gmail chengwei915@gmail.com
 */
(function(c,b,a,e){var d=(function(){return{init:function(){this.DEL_KEY=46;this.ENTER_KEY=13;this.BACKSPACE_KEY=8;this.trsDuration=300;this.setMessages();this.cacheElements();this.setAjaxDefaults();this.getUserInfo();this.userinfo={};this.requestMethod={post:"POST"}},setMessages:function(){this.pickIt="请选择";this.noData="暂无数据";this.loading="LOADING...";this.submitting="SUBMITTING...";this.hasLoaded="该流程已打开";this.delConfirm="该操作无法撤销，确定要执行吗？";this.reLoginConfirm="session过期了，是否需要重新登录？"},log:function(){try{console.log.apply(console,arguments)}catch(f){try{opera.postError.apply(opera,arguments)}catch(f){}}},getById:function(f){return c("#"+f)},preventDefault:function(f){f.preventDefault()},stopPropagation:function(f){f.stopPropagation()},cacheElements:function(){this.$waiting=c("#waiting");this.$username=c("#username");this.$waitingInfo=this.$waiting.find(".waiting-info")},bindEvents:function(){},render:function(){},waiting:function(f){this.$waiting.addClass("visible");this.$waitingInfo.html(f)},waitingDone:function(){this.$waiting.removeClass("visible");this.$waitingInfo.html("")},setAjaxDefaults:function(){c.ajaxSetup({complete:function(f){d.checkeSessionStatus(f)}})},checkeSessionStatus:function(f){var g;f=f||{};g=f.getResponseHeader("Session-Status");if(g==="timeout"){if(confirm(d.reLoginConfirm)){top.window.location.href="index.jsp"}}},getUserInfo:function(){c.ajax({url:"json/userinfo.json",dataType:"json",cache:false,success:function(f){var g=f.userinfo;if(f.success){d.userinfo=g;d.$username.html(g.username);d.getDbs()}else{d.$username.html("未知用户");d.log(f.message)}}})},getDbs:function(){c.ajax({url:"json/dbs.json?userName="+d.userinfo.userName,dataType:"json",cache:false,success:function(g){var h=c(".dbs"),f='<option value="${value}">${text}</option>',i='<option value="">'+g.message+"</option>",j=g.dbs;h.empty();h.append('<option value="">'+d.pickIt+"</option>");if(g.success){if(j&&j.length&&(typeof j!=="string")){c.template("html",f);h.append(c.tmpl("html",g.dbs));d.codeEditor.updateHintList(j)}else{h.append('<option value="">'+d.noData+"</option>")}}else{h.append(i)}}})},getTables:function(f){f=f||{};c.ajax({url:"json/tables.json?dbName="+f.db+"&userName="+d.userinfo.userName,dataType:"json",cache:false,success:function(i){var h=c(f.tablesSelector),g='<option value="${value}">${text}</option>',k='<option value="">'+i.message+"</option>",j=i.tables;h.empty();h.append('<option value="">'+d.pickIt+"</option>");if(i.success){if(j&&j.length&&(typeof j!=="string")){c.template("html",g);h.append(c.tmpl("html",i.tables));d.codeEditor.updateHintList(j)}else{h.append('<option value="">'+d.noData+"</option>")}}else{h.append(k)}}})}}})();d.init();b.app=d})(jQuery,window,document);(function(b){var a=(function(){return{init:function(){this.instance={};this.hintList=[];this.hintOptionsChanged=false;this.createSqlEditor();this.fixedKeyEvent()},createSqlEditor:function(){var c=$("#sql-editor")[0],d=CodeMirror.fromTextArea(c,{mode:"text/x-sql",lineNumbers:true,lineWrapping:true,completeOnSingleClick:true,hint:CodeMirror.hint.sql,hintOptions:{tables:a.hintList,completeSingle:false,completeOnSingleClick:true},extraKeys:{"Ctrl-Q":"autocomplete"}});$(d.display.wrapper).find("textarea").addClass("ignore");d.on("keyup",function(e,f){c.value=e.getValue()});this.instance["sql-editor"]=d},fixedKeyEvent:function(){var c=this.instance;for(var d in c){if(c.hasOwnProperty(d)){c[d].on("keyup",function(f,g){var i=f.getValue(),e=f.doc.getCursor().ch,h=i[e-1];if(g.keyCode===b.BACKSPACE_KEY&&f.getValue()!==""&&h!==" "&&e!=0){a.setHintOptions(f);f.showHint(f)}});c[d].on("inputRead",function(e,f){if(f.text!=" "){a.setHintOptions(e);e.showHint(e)}})}}},destroyCodeEditor:function(c){if(this.instance[c]){delete this.instance[c]}else{b.log("the CodeMirror find by id="+c+" dose not exsit")}},setHintOptions:function(c){if(this.hintOptionsChanged){var d=c.getOption("hintOptions");$.extend(d,{tables:this.hintList});c.setOption("hintOptions",d);this.hintOptionsChanged=false}},updateHintList:function(c){for(var d=0;d<c.length;d++){var e=c[d].text;if($.inArray(e,this.hintList)===-1){this.hintList.push(e)}}this.hintOptionsChanged=true}}})();a.init();b.codeEditor=a})(window.app||{});(function(d){var l=document.body,b=false,j,i,h,f,k,e,c,g,m,p,n,o;var a=(function(){return{init:function(){this.cacheElements();this.loadComponents();this.bindEvents()},cacheElements:function(){this.$container=$("#cmp-items")},bindEvents:function(){$(document).on("selectstart",this.disableSelectstart);$(document).on("mousedown",this.cmpMousedown);$(document).on("mousemove",this.cmpMousemove);$(document).on("mouseup",this.cmpMouseup);this.$container.on("click",".item",this.itemClick);this.$container.on("mouseenter",".cmp",this.showTips);this.$container.on("mouseleave",this.hideTips)},disableSelectstart:function(q){if(b){q.preventDefault()}},showTips:function(){var q,t,s,r;r=$(this);t=r.offset().top+4;s=a.$container.outerWidth();cssOpts={top:t+"px",left:s+"px"};q='<div class="cmp-desc pos-abs trs-all trs-ease"></div>';markupInfo="<p>[输入类型] "+r.data("input")+"</p>"+"<p>[输出类型] "+r.data("output")+"</p>"+"<p>[组件类型] "+r.data("type")+"</p>"+"<p>[组件入度] "+r.data("indegree")+"</p>"+"<p>[组件描述] "+r.data("desc")+"</p>";if(!n){n=$(q).appendTo(l)}n.css(cssOpts).html(markupInfo).addClass("visible")},hideTips:function(){if(n){n.removeClass("visible")}},itemClick:function(s){var q=$(this),r=q.closest(".items"),t=q.find(".item-head");if($(s.target).hasClass("item-head")){q.toggleClass("expend");t.toggleClass("fa-caret-right");if(r.hasClass("single-expend")){q.siblings().removeClass("expend")}}},cmpMousedown:function(s){var u=$(s.target),r=u.closest(".cmp"),t=u.closest(".item"),q=function(v){return u.data(v)?u.data(v):r.data(v)};if(u.hasClass("cmp")||r.size()){b=true;k=q("type");iconCls=q("icon");c=q("input");g=q("output");e=q("indegree");m=q("cmp-window");p=t.data("type");$(l).addClass("_jsPlumb_drag_select");if(!o){o=$('<div class="drag-virtual-element pos-abs"></div>').appendTo(l)}}},cmpMousemove:function(q){if(b){if(o.size()){h=q.pageX;f=q.pageY;j=o.outerWidth()/2;i=o.outerHeight()/2;o.show().css({left:h-j+"px",top:f-i+"px"})}}},cmpMouseup:function(s){var r=d.process;if(o&&o.size()&&b){var t=r.$processArea.offset(),q=util.guid();o.hide();$(l).removeClass("_jsPlumb_drag_select");if(parseInt(o.css("top"))>t.top&&parseInt(o.css("left"))>t.left){r.createProcessNode("jsPlumb-"+q,{left:parseInt(h-t.left-j),top:parseInt(f-t.top-i),input:c,output:g,iconCls:iconCls,cmpType:k,indegree:e,cmpWindow:m,parentType:p,prop:{}})}}if(o){o.css({left:"-1000px",top:"-1000px"})}b=false},loadComponents:function(q){q=q||{};$.ajax({url:"json/components.json",dataType:"json",cache:false,beforeSend:function(r){},success:function(t){var w=t.items,u=0,v=w.length,s='<div class="item expend">'+'<a class="item-head fa fa-caret-down" href="javascript:;"></a>'+'<div class="item-body clearfix"></div>'+"</div>",z='<div class="cmp" '+'data-type="${type}" '+'data-desc="${desc}" '+'data-icon="${iconCls}" '+'data-input="${input}" '+'data-output="${output}" '+'data-indegree="${indegree}" '+'data-cmp-window="${cmpWindow}">'+'<span class="fa ${iconCls} trs-all"></span>'+'<div class="cmp-text">${type}</div>'+"</div>";$.template("html",z);for(;u<v;u++){var x=w[u]["type"],y=w[u]["title"],r=$.tmpl("html",w[u]["subitems"]);a.$container.append(s);a.$container.find(".item").eq(u).data("type",x);a.$container.find(".item-head").eq(u).html(y);a.$container.find(".item-body").eq(u).html(r)}}})}}})();a.init();d.cmpItems=a})(window.app||{});(function(a){var b=(function(){return{init:function(){this.processId=null;this.processName=null;this.untitled="untitled";this.setMessages();this.setFilters();this.cacheElements();this.bindEvents();this.$cmpWindow.find(".method").trigger("change");this.$cmpWindow.find(".treeType").trigger("change");this.$cmpWindow.find(".optimizer").trigger("change")},afterSave:function(){},setMessages:function(){this.noProcessData="还没有流程数据哦！";this.resetConfirmTips="请确认当前流程是否已保存...\n确定将切换至新流程"},setFilters:function(){this.foucsElements="input,select,textarea",this.enabledFirst=":enabled:first",this.enabledErrorFirst=".form-error-tips:enabled:first",this.noConnEndpoints="._jsPlumb_endpoint:not(._jsPlumb_endpoint_connected)"},cacheElements:function(){this.$cmpWindow=$(".cmp-window");this.$processArea=$("#process-area");this.$processTitle=$("#process-title");this.$processNameWindow=$("#process-name-window");this.$processName=this.$processNameWindow.find("#process-name");this.$mask=$(".mask");this.$normalContent=$(".normal-content");this.$windowSelect=$("#window-select")},bindEvents:function(){this.$cmpWindow.on("blur",".ui-input",this.blurTips);this.$cmpWindow.on("focus",".ui-input",this.focusTips);this.$cmpWindow.on("click",".ok",this.okSetData);this.$cmpWindow.on("click",".cancel, .x",this.cancelSetData);this.$cmpWindow.on("click",".execute",this.justExecute);this.$cmpWindow.on("click",".get-tree-pic",this.executeToLoadPic);this.$cmpWindow.on("click",".get-grid-data",this.executeToLoadGridData);this.$cmpWindow.on("click",".get-chart-data",this.executeToLoadChartData);this.$cmpWindow.on("change",".dbs",this.dbChange);this.$cmpWindow.on("change",".method",this.methodChange);this.$cmpWindow.on("change",".treeType",this.treeTypeChange);this.$cmpWindow.on("change",".optimizer",this.optimizerChange);this.$cmpWindow.on("keypress","form",this.formEnterKeypress);this.$processArea.on("click",".process-node",this.selectProcessNode);this.$processArea.on("dblclick",".process-node",this.openCmpWindow);this.$processArea.on("mouseenter",".process-node",this.delNoConnEndpoints);this.$processArea.on("selectstart",a.preventDefault);this.$processNameWindow.on("keyup","#process-name",this.checkProcessNameChange);this.$processNameWindow.on("focus","#process-name",this.checkProcessNameChange);this.$processNameWindow.on("click","#post-process-data",this.checkNsaveProcess);this.$windowSelect.on("keyup focus",".select-input",this.selectOne);$(document).on("keyup",this.delProcessNode)},checkProcessNameChange:function(){var d=$(this),c=d.closest("form");if(d.val()){c.validate(app.getFormValidateOpts(c));a.log(d.val(),c.valid())}},checkNsaveProcess:function(){var d=$(this),c=d.closest("form");c.validate(app.getFormValidateOpts(c));if(c.valid()){b.saveProcess()}else{c.find(b.foucsElements).filter(b.enabledErrorFirst).focus();return}},focusTips:function(g){var d=this,c=$(d),f=c.closest(".cmp-window");f.find("[data-tips-for="+d.name+"]").addClass("focus")},blurTips:function(c){$(this).closest(".cmp-window").find(".field-tips-item").removeClass("focus")},selectProcessNode:function(){var c=$(this);c.addClass("active");c.siblings().removeClass("active")},delNoConnEndpoints:function(){$(b.noConnEndpoints).remove()},delProcessNode:function(d){var c=b.$processArea.find(".process-node.active");if(c&&c.size()){if(!d.altKey&&!d.ctrlKey&&!d.metaKey&&!d.shiftKey&&d.keyCode==a.DEL_KEY){b.jsPlumbInstance.detachAllConnections(c.attr("id"));c.remove()}}},createProcessNode:function(i,h){h=h||{};var g,f,d,c,e;d=this.jsPlumbInstance;e=this.$processArea;e.find(".process-node").removeClass("active");g=$('<div class="process-node active trs-all trs-growup fa"></div>').appendTo(e).addClass(h.iconCls).append('<div class="node-text">'+(h.nodeText||h.cmpType)+"</div>").append('<div class="ep"></div>').data("prop",h.prop).data("type",h.cmpType).data("icon",h.iconCls).data("input",h.input).data("output",h.output).data("indegree",h.indegree).data("cmp-window",h.cmpWindow).data("parent-type",h.parentType).attr("id",i).css({top:h.top+"px",left:h.left+"px"});f=g.find(".node-text");f.css({"margin-left":-f.outerWidth()/2+"px"});setTimeout(function(){a.getById(i).addClass("growup")},0);d.draggable(i,{containment:true});d.makeSource(i,{filter:".ep",anchor:"Continuous",connector:["StateMachine",{curviness:20}],connectorStyle:{strokeStyle:"#5c96bc",lineWidth:2,outlineColor:"transparent",outlineWidth:4}});d.makeTarget(i,{anchor:"Continuous",allowLoopback:false,dropOptions:{hoverClass:"dragHover"},maxConnections:g.data("indegree"),onMaxConnections:function(k,j){a.log("Maximum connections ("+k.maxConnections+") reached")}});d.unbind("click");d.unbind("connection");d.bind("click",function(k,j){d.detach(k)});d.bind("connection",function(m){var r=$(m.source),l=$(m.target),k=r.data("output").split("|"),q=l.data("input").split("|"),u=[],j=[],s=[],v=d.getEndpoints(m.sourceId)||[],p=d.getEndpoints(m.targetId)||[];for(var o=0;len=q.length,o<len;o++){if($.inArray(q[o],k)!=-1){u.push(q[o])}}function t(w){return w&&w.connections&&w.connections.length}function n(){return k[0]==="disable"||q[0]==="disable"||(k[0]!=="*"&&q[0]!=="*"&&!u.length)}if(n()){$(b.noConnEndpoints).remove();d.detach(m.connection)}})},openCmpWindow:function(){var e,p,j=$(this),h=j.data("type"),o=j.data("prop"),n=j.data("cmp-window"),l=$("#window-"+h),f=l.find(b.foucsElements),k=!!l.data("set-pos");if(!n){return}l.find(".cmp-window-header").html("component@"+h);l.addClass("visible").data("belong-to",j);b.$mask.addClass("visible");setTimeout(function(){f.filter(b.enabledFirst).focus().select()},a.trsDuration);e=l.outerWidth();p=l.outerHeight();if(!k){l.css({"position":"absolute","top":"50%","left":"50%","margin-top":-p/2+"px","margin-left":-e/2+"px"});k=true}if(o){for(var g in o){if(o.hasOwnProperty(g)){var d="[name="+g+"]",m=l.find(d);m.val(o[g]);if(m.data("type")==="codemirror"){var c=a.codeEditor.instance[m.attr("id")];c.setValue(m.val())}}}}},dbChange:function(f){var d=this,g=d.value,c=$("[data-belong-to="+d.id+"]");a.getTables({db:g,tablesSelector:c})},optimizerChange:function(r){var s=this,h=s.value,k="SGD",d="L-BFGS",o="data-associate-value",m="disabled",i=".label-item",n=$(this),j=n.closest(".cmp-window"),q=j.find("[name=updater]"),p=q.find("[value=L1Updater]"),l=j.find("["+o+"="+k+"]"),g=j.find("["+o+"="+d+"]"),f=l.closest(i),c=g.closest(i);f=f.size()?f:l.closest("tr");c=c.size()?c:g.closest("tr");q.val("");if(h===k){l.prop(m,false);g.prop(m,true);p.prop(m,false);f.show();c.hide()}else{if(h===d){g.prop(m,false);l.prop(m,true);p.prop(m,true);f.hide();c.show()}else{}}},methodChange:function(){var r=this,g=r.value,p="normal",f="uniform",h="poisson",n="data-associate-value",l="disabled",i=".label-item",m=$(this),k=m.closest(".cmp-window"),o=k.find("["+n+"="+p+"]"),d=k.find("["+n+"="+f+"]"),j=k.find("["+n+"="+h+"]"),c=o.closest(i),q=d.closest(i),e=j.closest(i);c=c.size()?c:o.closest("tr");q=q.size()?q:d.closest("tr");e=e.size()?e:j.closest("tr");if(g===p){o.prop(l,false);d.prop(l,true);j.prop(l,true);c.show();q.hide();e.hide()}else{if(g===f){o.prop(l,true);d.prop(l,false);j.prop(l,true);c.hide();q.show();e.hide()}else{if(g===h){o.prop(l,true);d.prop(l,false);j.prop(l,false);c.hide();q.hide();e.show()}else{}}}},treeTypeChange:function(o){var p=this,h=p.value,c="Classification",g="Regression",n="data-associate-value",k="disabled",i=".label-item",m=$(this),j=m.closest(".cmp-window"),l=j.find("[name=impurity]"),s=l.find("[value=gini]"),f=l.find("[value=entropy]"),r=l.find("[value=variance]"),q=j.find("["+n+"="+c+"]"),d=q.closest(i);d=d.size()?d:q.closest("tr");l.val("");if(h===c){s.prop(k,false);f.prop(k,false);r.prop(k,true);q.prop(k,false);d.show()}else{if(h===g){s.prop(k,true);f.prop(k,true);r.prop(k,false);q.prop(k,true);d.hide()}else{}}},selectOne:function(){var c=$(this),d=b.$windowSelect.find(".select-input");if(c.val()){d.prop("disabled",true);c.prop("disabled",false)}else{d.prop("disabled",false)}},okSetData:function(){var j=$(this),d=j.closest(".cmp-window"),e=j.closest("form"),g=d.find(".ui-input"),f=0,c=g.size(),h={};if(e.size()){e.validate(app.getFormValidateOpts(e));if(!e.valid()){e.find(b.foucsElements).filter(b.enabledErrorFirst).focus();return}}for(;f<c;f++){if(g[f].name){h[g[f].name]=g[f].value}}d.data("belong-to").data("prop",h);d.removeClass("visible");b.$mask.removeClass("visible")},cancelSetData:function(){var c=$(this).closest(".cmp-window"),d=c.find("form"),e=b.$mask;c.removeClass("visible").find(".close-to-empty").html("");e.removeClass("visible");if(d.size()){d.validate().resetForm()}},formEnterKeypress:function(c){if(c.keyCode===a.ENTER_KEY&&!$(c.target).is("select")){$(this).find(".ok, #post-process-data").trigger("click")}},justExecute:function(){if(!b.isSavedProcess()){b.setProcessName();return false}var d=$(this),c=d.closest(".cmp-window"),e=c.data("belong-to").attr("id");b.processId=b.processId||"PROCESS-"+util.guid();$.ajax({url:"json/execute.json?processId="+b.processId+"&nodeId="+e,dataType:"json",cache:false,beforeSend:function(){a.waiting(a.submitting)},success:function(f){a.waitingDone();alert(f.message)},complete:function(){c.find(".ok").trigger("click")}})},executeToLoadPic:function(){if(!b.isSavedProcess()){b.setProcessName();return false}var e=$(this),c=e.closest(".cmp-window"),d=c.find(".cmp-pic-container"),f=c.data("belong-to").attr("id");b.processId=b.processId||"PROCESS-"+util.guid();$.ajax({url:"json/tree-display.json?processId="+b.processId+"&nodeId="+f,dataType:"json",cache:false,beforeSend:function(){d.html(a.loading)},success:function(g){var j=g.picturePath,i='<div class="error-msg">'+g.message+"</div>",h='<a hidefocus target="_blank" href="'+j+'" title="点击查看完整图片">'+'<img style="width:100%" src="'+j+'">'+"</a>";if(g.success){d.html(h)}else{d.html(i)}}})},executeToLoadGridData:function(){if(!b.isSavedProcess()){b.setProcessName();return false}var e=$(this),c=e.closest(".cmp-window"),d=c.find(".cmp-grid-container"),f=c.data("belong-to").attr("id");b.processId=b.processId||"PROCESS-"+util.guid();$.ajax({url:"json/grid.json?processId="+b.processId+"&nodeId="+f,dataType:"json",cache:false,beforeSend:function(){d.html(a.loading)},success:function(j){var r=j.rows,k=0,m=r[0],o,g,q="",n="",p='<div class="empty-msg">'+a.noData+"</div>",l='<div class="error-msg">'+j.message+"</div>",h=j.columns||[];if(j.success){if(r&&r.length&&(typeof r!=="string")){for(var k in m){if(m.hasOwnProperty(k)){if(k==="index"){q+='<td class="index">${'+k+"}</td>"}else{q+="<td>${"+k+"}</td>"}}}for(var k=0;k<h.length;k++){if(k==0){n+='<th class="index">'+j.columns[k].title+"</th>"}else{n+="<th>"+j.columns[k].title+"</th>"}}q="<tr>"+q+"</tr>";n="<thead><tr>"+n+"</tr></thead>";$.template("html",q);g=$.tmpl("html",r);o=$("<table></table>").addClass("config-table").append(n).append(g);o.find("tbody tr:odd").addClass("odd");d.html(o)}else{d.html(p)}}else{d.html(l)}}})},executeToLoadChartData:function(){if(!b.isSavedProcess()){b.setProcessName();return false}var e=$(this),c=e.closest(".cmp-window"),d=c.find(".cmp-chart-container"),f=c.data("belong-to").attr("id");b.processId=b.processId||"PROCESS-"+util.guid();$.ajax({url:"json/chart-data.json?processId="+b.processId+"&nodeId="+f,dataType:"json",cache:false,beforeSend:function(g){d.html(a.loading)},success:function(g){var i=g.series,h='<div class="empty-msg">'+a.noData+"</div>",j='<div class="error-msg">'+g.message+"</div>",k={chart:{type:"column",style:{fontFamily:'"Microsoft Yahei", simsun, "Lucida Grande", Monospace'}},title:{text:g.chartTitle},xAxis:{categories:g.categories},yAxis:{min:0,title:{text:g.yAxisTitle}},tooltip:{headerFormat:'<span style="font-size:10px">{point.key}</span><table>',pointFormat:'<tr><td style="color:{series.color};padding:0">{series.name}: </td>'+'<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',footerFormat:"</table>",shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:g.series};if(g.success){if(i&&i.length&&(typeof i!=="string")){d.highcharts(k)}else{d.html(h)}}else{d.html(j)}}})},isSavedProcess:function(){return !!b.processId&&!!b.processName},isEmptyProcess:function(){return !$.trim(this.$processArea.html())},setProcessName:function(){var c=this.$processArea.find(".process-node");if(c.size()){if(this.isSaveAs){this.$processName.val(this.$processTitle.html()+"-copy")}else{this.$processName.val(this.untitled)}this.$processNameWindow.addClass("visible");this.$mask.addClass("visible");setTimeout(function(){b.$processName.focus().select()},a.trsDuration)}else{alert(this.noProcessData)}},resetProcessArea:function(){this.$processArea.empty();this.jsPlumbInstance.reset()},resetConfirm:function(){if(confirm(b.resetConfirmTips)){return true}else{return false}},newProcess:function(){if(this.resetConfirm()){this.resetProcessArea();this.processId=null;this.processName=null;this.$processTitle.html(this.untitled)}},copyProcess:function(){},delProcess:function(c){$.ajax({url:"json/del-process.json",data:{processId:c},dataType:"json",traditional:true,success:function(d){a.processList.load()}})},saveProcess:function(){var f=this,e=[],g=[],l=[],m="PROCESS-"+util.guid(),d=$.trim(f.$processName.val()),c=f.processId?f.processId:m,j=f.processName?f.processName:d,k={},i="",h=f.$processArea.find(".process-node");if(f.isSaveAs){c=m;j=d}h.each(function(n,o){var o=$(o);e.push({nodeId:o.attr("id"),nodeName:o.attr("id"),iconCls:o.data("icon"),property:o.data("prop"),nodeType:o.data("type"),input:o.data("input"),output:o.data("output"),indegree:o.data("indegree"),cmpWindow:o.data("cmp-window"),parentType:o.data("parent-type"),nodePosTop:parseInt(o.css("top")),nodePosLeft:parseInt(o.css("left"))})});$.each(f.jsPlumbInstance.getConnections(),function(n,o){l.push({targetId:o.targetId,sourceId:o.sourceId,connectorId:o.id,connectorName:o.id,connectorType:"data"})});k.nodes=e;k.processId=c;k.processName=j;k.connections=l;i=JSON.stringify(k);$.ajax({url:"json/save-process.json",dataType:"json",data:{processData:i},beforeSend:function(){a.waiting(a.submitting)},success:function(n){f.$processTitle.html(j);f.$processNameWindow.removeClass("visible");f.$mask.removeClass("visible");f.processId=c;f.processName=j;f.isSaveAs=false;a.waitingDone();a.processList.load();alert(n.message)}})},loadProcess:function(d,c){$.ajax({url:"json/"+c+"?processId="+d,dataType:"json",cache:false,beforeSend:function(){a.waiting(a.loading)},success:function(h){b.resetProcessArea();b.processId=h.processId;b.processName=h.processName;b.$processTitle.html(h.processName);a.waitingDone();for(var k=0;k<h.nodes.length;k++){var f=h.nodes[k],j=f.nodeType,n=f.property||{},e=n.db_name,l=n.dt_name;b.createProcessNode(f.nodeId,{top:f.nodePosTop,left:f.nodePosLeft,iconCls:f.iconCls,cmpType:j,indegree:f.indegree,cmpWindow:f.cmpWindow,parentType:f.parentType,prop:n,input:f.input,output:f.output});b.jsPlumbInstance.revalidate(f.nodeId);if(e&&l){var m=$("#window-"+j);a.getTables({db:e,tablesSelector:m.find("[name=dt_name]")})}}for(var k=0;k<h.connections.length;k++){var g=h.connections[k];b.jsPlumbInstance.connect({source:g.sourceId,target:g.targetId})}}})}}})();b.init();a.process=b})(window.app||{});(function(a){var b=(function(){return{init:function(){this.operateMode=false;this.cacheElements();this.bindEvents()},cacheElements:function(){this.$processListPanel=$("#process-list-panel");this.$processList=this.$processListPanel.find("#process-list")},bindEvents:function(){this.$processListPanel.on("click",a.stopPropagation);this.$processListPanel.on("keyup",a.stopPropagation);this.$processListPanel.on("keyup",".filter",this.filter);this.$processListPanel.on("click",".remove-btn",this.removeCheckedItem);this.$processListPanel.on("click",".cancel-btn",$.proxy(this.cancelOperating,this));this.$processListPanel.on("click",".refresh-btn",$.proxy(this.load,this));this.$processListPanel.on("click",".operating-btn",$.proxy(this.operating,this));this.$processListPanel.on("click",".toggle-check",this.toggleCheck);this.$processListPanel.on("click",".process-item",this.itemClick);this.$processListPanel.on("click",".item-checkbox",this.itemCheckboxClick);this.$processListPanel.on("click",".remove-item-btn",this.removeCurItem);$(document).on("click",$.proxy(this.hide,this))},isEmpty:function(){return !this.$processList.find(".process-item").size()},show:function(){var c=this.$processListPanel;c.addClass("shown");c.find(".filter").focus();if(this.isEmpty()){this.load()}},hide:function(){this.$processListPanel.removeClass("shown")},operating:function(){this.operateMode=true;this.$processListPanel.addClass("operating")},cancelOperating:function(){this.operateMode=false;this.$processListPanel.removeClass("operating")},filter:function(k){var j=$(this),h=j.val(),d=j.closest(".process-list-panel").find(".process-item"),g=0,c=d.size();d.hide();for(;g<c;g++){var f=d.eq(g);util.match(h,f.find(".process-name").text())&&f.show()}},toggleCheck:function(h){var d=$(this),g="checked",f=d.closest("#process-list-panel"),c=f.find(".item-checkbox");if(d.prop(g)===true){c.prop(g,true)}else{c.prop(g,false)}},itemCheckboxClick:function(j){var g=$(this),i="checked",h=g.closest("#process-list-panel"),d=h.find(".item-checkbox:checked"),f=h.find(".item-checkbox"),c=h.find(".toggle-check");if(d.size()===f.size()){c.prop(i,true)}if(!g.prop(i)){c.prop(i,false)}j.stopPropagation()},removeCurItem:function(d){var c=$(this),f=c.data("process-id");if(confirm(a.delConfirm)){a.process.delProcess(f)}d.stopPropagation()},removeCheckedItem:function(h){var j=[],f=$(this),g=f.closest("#process-list-panel"),c=g.find(".item-checkbox:checked");$toggleCheck=g.find(".toggle-check");if(c.size()){for(var d=0;d<c.size();d++){j.push($(c[d]).data("process-id"))}if(confirm(a.delConfirm)){a.process.delProcess(j);$toggleCheck.prop("checked",false)}}},itemClick:function(f){var d=a.process;if(!a.processList.operateMode){var c=$(this),g=c.data("process-id");resource=c.data("resource");if(g===d.processId){alert(a.hasLoaded);return}else{if(d.resetConfirm()){d.loadProcess(g,resource)}}}},load:function(){var c=this.$processList;$.ajax({url:"json/process-list.json",dataType:"json",cache:false,beforeSend:function(){c.html("<li>"+a.loading+"</li>")},success:function(d){var e=d.rows,f="";emptyProcessList='<li class="empty-msg">'+a.noData+"</li>",errorProcessList='<li class="error-msg">'+d.message+"</li>",templateProcessList='<li class="process-item" data-process-id="${processId}" data-resource="${resource}">'+'<a hidefocus class="pos-rel" href="javascript:;">'+'<p class="process-name ellipsis" title="${processName}">${processName}</p>'+'<span class="pos-abs remove-item-btn" data-process-id="${processId}">删除</span>'+'<input class="pos-abs item-checkbox" data-process-id="${processId}" type="checkbox">'+"</a>"+"</li>";if(d.success){if(e&&e.length&&(typeof e!=="string")){$.template("html",templateProcessList);f=$.tmpl("html",d.rows);c.html(f)}else{c.html(emptyProcessList)}}else{c.html(errorProcessList)}}})}}})();b.init();a.processList=b})(window.app||{});(function(b){var a=(function(){return{init:function(){this.cacheElements();this.bindEvents()},cacheElements:function(){this.$topbar=$("#topbar")},bindEvents:function(){var c=b.process;var d=b.processList;this.$topbar.on("click","#help",function(f){});this.$topbar.on("click","#new-process",$.proxy(c.newProcess,c));this.$topbar.on("click","#save-process",this.saveLinkClick);this.$topbar.on("click","#save-process-as",this.saveAsLinkClick);this.$topbar.on("click","#open-process-list",$.proxy(d.show,d));this.$topbar.on("click","#open-process-list",b.stopPropagation)},saveLinkClick:function(){var c=b.process;c.isSaveAs=false;if(c.isSavedProcess()){c.saveProcess()}else{c.setProcessName()}},saveAsLinkClick:function(){var c=b.process;c.isSaveAs=true;c.setProcessName()}}})();a.init();b.topbar=a})(window.app||{});jsPlumb.ready(function(){app.process.jsPlumbInstance=jsPlumb.importDefaults({Endpoint:["Dot",{radius:2}],HoverPaintStyle:{strokeStyle:"#00D88E",lineWidth:2},ConnectionOverlays:[["Arrow",{location:1,id:"arrow",length:14,foldback:0.8}]],Container:app.process.$processArea[0]});jsPlumb.fire("jsPlumbDemoLoaded",app.process.jsPlumbInstance)});